<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>OAuth2 + OIDC + Refresh</title>
</head>
<body>
<button id="login-btn">Login</button>
<button id="fetch-tasks-btn">Fetch Tasks</button>
<button id="refresh-btn">Refresh Token</button>
<script>
  // Утилиты для PKCE
  async function generateCodeVerifier() {
    const array = new Uint8Array(32);
    crypto.getRandomValues(array);
    return btoa(String.fromCharCode(...array))
            .replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
  }
  async function generateCodeChallenge(verifier) {
    const data = new TextEncoder().encode(verifier);
    const digest = await crypto.subtle.digest('SHA-256', data);
    return btoa(String.fromCharCode(...new Uint8Array(digest)))
            .replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
  }

  // Шаг 1: отправка логина/пароля
  async function performLogin() {
    const form = new URLSearchParams({
      username: 'chousik',
      password: 'chousik'
    });
    await fetch('http://localhost:8071/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: form
    });
    // после этого JSESSIONID установится и вы в сессии
    startAuthorize();
  }

  // Шаг 2: редирект на authorize
  async function startAuthorize() {
    const verifier = await generateCodeVerifier();
    const challenge = await generateCodeChallenge(verifier);
    const state = Math.random().toString(36).substring(2);
    sessionStorage.setItem('pkce_verifier', verifier);
    sessionStorage.setItem('oauth_state', state);

    const params = new URLSearchParams({
      response_type: 'code',
      client_id: 'client',
      redirect_uri: 'https://your-frontend.com/callback',
      scope: 'openid profile email offline_access',
      state,
      code_challenge: challenge,
      code_challenge_method: 'S256'
    });
    window.location.href = `http://localhost:8071/oauth2/authorize?${params}`;
  }

  // Шаг 3: обработка callback
  async function handleCallback() {
    const url = new URL(window.location.href);
    const code = url.searchParams.get('code');
    const state = url.searchParams.get('state');
    if (state !== sessionStorage.getItem('oauth_state')) {
      console.error('Invalid state'); return;
    }
    const verifier = sessionStorage.getItem('pkce_verifier');

    // Шаг 4: обмен кода на токены
    const tokenResp = await fetch('http://localhost:8071/oauth2/token', {
      method: 'POST',
      headers: { 'Content-Type':'application/x-www-form-urlencoded' },
      body: new URLSearchParams({
        grant_type: 'authorization_code',
        code,
        redirect_uri: 'https://your-frontend.com/callback',
        code_verifier: verifier,
        client_id: 'client'
      })
    }).then(r=>r.json());

    localStorage.setItem('access_token', tokenResp.access_token);
    localStorage.setItem('id_token', tokenResp.id_token);
    localStorage.setItem('refresh_token', tokenResp.refresh_token);
    console.log('Tokens:', tokenResp);
  }

  // Шаг 5: вызов защищённого API
  async function fetchTasks() {
    const token = localStorage.getItem('access_token');
    const resp = await fetch('http://localhost:8080/api/tasks', {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    console.log(await resp.json());
  }

  // Шаг 6: обновление токена
  async function refreshAccessToken() {
    const refresh = localStorage.getItem('refresh_token');
    const tokenResp = await fetch('http://localhost:8071/oauth2/token', {
      method: 'POST',
      headers: { 'Content-Type':'application/x-www-form-urlencoded' },
      body: new URLSearchParams({
        grant_type: 'refresh_token',
        refresh_token: refresh,
        client_id: 'client'
      })
    }).then(r=>r.json());

    localStorage.setItem('access_token', tokenResp.access_token);
    localStorage.setItem('refresh_token', tokenResp.refresh_token);
    console.log('Refreshed tokens:', tokenResp);
  }

  // Устанавливаем обработчики
  document.getElementById('login-btn').onclick = performLogin;
  document.getElementById('fetch-tasks-btn').onclick = fetchTasks;
  document.getElementById('refresh-btn').onclick = refreshAccessToken;

  // Если мы на callback‑странице
  if (window.location.pathname === '/callback') {
    handleCallback();
  }
</script>
</body>
</html>
